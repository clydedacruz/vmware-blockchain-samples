# VMBC K8s Orchestrator service

## Deploy K8s Orchestrator

```
helm install <desired name of your installation> <relative path to this folder> --set global.imageCredentials.registry=<registry> --set global.imageCredentials.username=<username> --set global.imageCredentials.password=<password>
```

## Generate VMBC Helm Charts

### Create descriptors with desired configurations
Create a folder of your choice and place the following in descriptors in it.
- Deployment descriptor (lets say /<path-to-folder-of-your-choice>/deployment.json)
- Infrastructure descriptor (lets say /<path-to-folder-of-your-choice>/infrastructure.json)
  
### Sample descriptors
See below for sample descriptors
- [Deployment descriptor](./sample-descriptors/deployment.json)
- [Infrastructure descriptor](./sample-descriptors/infrastructure.json)

### Get API URL

Run the below command to fetch url for API

#### Minikube
```
minikube service list
```

#### EKS
```
kubectl get svc
```

### Generate and download VMWare Blockchain helm charts

Assuming you have HTTPIE installed, run the below command
```
http --download GET http://<url>/api/v1/charts infraDescriptor:=@/<path-to-folder-of-your-choice/infrastructure.json> deploymentDescriptor:=@/<path-to-folder-of-your-choice/descriptors/deployment.json>
```
where <url> is the service url when using Minikube and the EXTERNAL-IP when using EKS

Alternately, you can also provide the entire json files for both the descriptors to the command.

The zip file containing the helm charts will be downloaded to your current directory. Please see file name starting with "vmbc-". Unzip the folder and you are ready to install the blockchain.

### Folder Structure
#### Sample Folder Structure
##### Single Cluster Deployment
```
<Name of downloaded unzipped folder>
├── <UUID for deployment>
│   └── <zone name>
|       <Helm charts for this zone>
├── castor-<consortium name>_<yyyy-dd-mm>T<hh:mm:ss.millis>
├── castor-<consortium name>_<yyyy-dd-mm>T<hh:mm:ss.millis>.json
├── <deployment.json>
└── <infrastructure.json>
```
##### Multi Cluster Deployment
```
<Name of downloaded unzipped folder>
├── <UUID for deployment>
│   └── <zone-1 name>
|       <Helm charts for zone-1>
│   └── <zone-2 name>
|       <Helm charts for this zone-2>
...
...
├── castor-<consortium name>_<yyyy-dd-mm>T<hh:mm:ss.millis>
├── castor-<consortium name>_<yyyy-dd-mm>T<hh:mm:ss.millis>.json
├── <deployment.json>
└── <infrastructure.json>
```
#### Legends
- `UUID for deployment` is the session id generated by the k8s orchestrator tool
- `consortium name` is the name of the consortium provided in deployment descriptor
- `zone name` is the name of the zone or cluster definition provided in infrastructure descriptor
- `deployment.json` and <infrastructure.json> are the exact input provided to the k8s orchestrator tool
